<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Kvartální Report</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* ZÁKLADNÍ NASTAVENÍ */
    body { 
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
      background: #f0f0f0; 
      padding: 20px; 
      margin: 0;
      color: #333;
    }
    
    /* "PAPÍR" A4 */
    .page {
      background: white;
      width: 210mm;
      min-height: 297mm;
      margin: 0 auto;
      padding: 15mm;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      box-sizing: border-box; 
    }

    /* HLAVIČKA */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .header-left h1 { margin: 0; font-size: 26px; text-transform: uppercase; color: #2c3e50; }
    .header-left .sub { font-size: 16px; color: #666; margin-top: 5px; }
    
    .score-badge {
      text-align: center;
      border: 3px solid #333;
      padding: 5px 15px;
      border-radius: 8px;
    }
    .score-val { font-size: 32px; font-weight: bold; display: block; line-height: 1; }
    .score-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

    /* KPI BOX (Manažerské shrnutí) */
    .kpi-bar {
      display: flex;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
    }
    .kpi-item {
      flex: 1;
      text-align: center;
      border-right: 1px solid #ddd;
    }
    .kpi-item:last-child { border-right: none; }
    .kpi-val { font-size: 18px; font-weight: bold; color: #2c3e50; display: block; }
    .kpi-label { font-size: 11px; color: #7f8c8d; text-transform: uppercase; margin-top: 4px; display: block;}

    /* TABULKA */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; background: #2c3e50; color: white; padding: 10px 8px; font-weight: 600; }
    td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: top; color: #444; }
    
    /* Styl problémového řádku */
    tr.problem-row td { background-color: #fff5f5; color: #c0392b; font-weight: 500; }
    tr.problem-row td.note { font-weight: bold; }

    .status-ok { color: #27ae60; font-weight: bold; }
    .status-wait { color: #e67e22; font-weight: bold; }
    .status-err { color: #c0392b; font-weight: bold; }
    
    /* TISK (CSS pro Ctrl+P) */
    @media print {
      body { background: white; padding: 0; }
      .page { box-shadow: none; margin: 0; padding: 0; width: 100%; }
      .kpi-bar { background: none !important; border: 1px solid #ccc; }
      th { background: #ddd !important; color: black !important; -webkit-print-color-adjust: exact; }
      tr.problem-row td { background-color: transparent !important; color: black !important; }
      tr.problem-row td.note { text-decoration: underline; } 
    }
  </style>
</head>
<body>

<div class="page" id="report-container">
  <div style="text-align: center; padding-top: 50px; color: #999;">
    Načítám data...
  </div>
</div>

<script>
  grist.ready({
    columns: ['Tiskova_Data'],
    requiredAccess: 'read table'
  });

  grist.onRecord(function(record) {
    const container = document.getElementById('report-container');
    const rawData = record.Tiskova_Data;

    if (!rawData) {
      container.innerHTML = '<div style="text-align: center; padding-top: 50px; color: #999;">Žádná data pro zobrazení.</div>';
      return;
    }

    let data;
    try {
      data = JSON.parse(rawData);
    } catch (e) {
      container.innerHTML = '<div style="color:red; padding:20px;">Chyba dat (JSON): ' + e.message + '</div>';
      return;
    }

    const h = data.hlavicka;

    // Generování HTML
    let html = `
      <header>
        <div class="header-left">
          <h1>${h.dodavatel}</h1>
          <div class="sub">Kvartální hodnocení: <strong>${h.obdobi}</strong></div>
        </div>
        <div class="score-badge">
          <span class="score-val">${h.skore_procenta} %</span>
          <span class="score-label">Výsledek</span>
        </div>
      </header>

      <div class="kpi-bar">
        <div class="kpi-item">
          <span class="kpi-val">${h.obrat}</span>
          <span class="kpi-label">Celkový obrat</span>
        </div>
        <div class="kpi-item">
          <span class="kpi-val">${h.pocet_celkem}</span>
          <span class="kpi-label">Počet objednávek</span>
        </div>
        <div class="kpi-item">
          <span class="kpi-val" style="color: ${h.pocet_zpozdenych > 0 ? '#c0392b' : '#27ae60'}">
            ${h.pocet_zpozdenych}
          </span>
          <span class="kpi-label">Zpožděno / Problém</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 10%">Datum</th>
            <th style="width: 15%">Číslo obj.</th>
            <th style="width: 15%; text-align: right;">Cena</th>
            <th style="width: 15%; padding-left: 20px;">Status</th>
            <th style="width: 45%">Poznámka / Problém</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (data.radky && data.radky.length > 0) {
      data.radky.forEach(r => {
        let rowClass = r.je_problem ? 'problem-row' : '';
        
        let statusHtml = r.status;
        if (!r.je_problem) {
             if (r.status.includes('Doručeno')) statusHtml = `<span class="status-ok">${r.status}</span>`;
             else if (r.status.includes('Probíhá')) statusHtml = `<span class="status-wait">${r.status}</span>`;
        } else {
             statusHtml = `<span class="status-err">${r.status}</span>`;
        }

        html += `
          <tr class="${rowClass}">
            <td>${r.datum}</td>
            <td>${r.cislo}</td>
            <td style="text-align: right;">${r.cena}</td>
            <td style="padding-left: 20px;">${statusHtml}</td>
            <td class="note">
              ${r.je_problem ? `⚠️ ${r.text_problemu}` : ''}
            </td>
          </tr>
        `;
      });
    } else {
        html += `<tr><td colspan="5" style="text-align:center; padding: 20px;">Žádné objednávky.</td></tr>`;
    }

    html += `
        </tbody>
      </table>

      <div style="margin-top: 50px; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between;">
        <span>Interní report kvality dodavatelů</span>
        <span>Vytištěno: ${new Date().toLocaleDateString('cs-CZ')}</span>
      </div>
    `;

    container.innerHTML = html;
  });
</script>

</body>
</html>