<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Kvart√°ln√≠ Hodnocen√≠</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* --- Z√ÅKLAD --- */
    body { font-family: 'Segoe UI', sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; color: #000; }
    
    /* √öPRAVA 1: Flexbox pro spr√°vn√© rozta≈æen√≠ obsahu */
    .page { 
      background: white; 
      width: 210mm; 
      min-height: 297mm; /* Minim√°lnƒõ A4, ale m≈Ø≈æe r≈Øst */
      margin: 0 auto 20px auto; 
      padding: 20mm; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
      box-sizing: border-box; 
      display: flex; 
      flex-direction: column; 
    }
    
    @media print {
      body { background: none; padding: 0; }
      /* √öPRAVA 2: Reset v√Ω≈°ky pro tisk√°rnu, aby mohla str√°nkovat */
      .page { 
        width: 100%; 
        height: auto; /* D≈Øle≈æit√©: u≈æ ne fixn√≠ v√Ω≈°ka */
        box-shadow: none; 
        margin: 0; 
        padding: 15mm; 
        display: block; /* Pro tisk je block bezpeƒçnƒõj≈°√≠ ne≈æ flex */
      }
      .no-print { display: none !important; }
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    /* --- HLAVIƒåKA --- */
    .header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-start; }
    .logo-img { height: 90px; width: auto; max-width: 300px; object-fit: contain; margin-bottom: 15px; display: block; }
    .header h1 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
    .meta-date { text-align: right; font-size: 14px; font-weight: bold; margin-top: 5px; }

    /* --- DASHBOARD --- */
    .dashboard-container { display: flex; gap: 30px; margin-bottom: 35px; align-items: stretch; }
    .score-section { flex: 0 0 30%; background: #f4f4f4; border-left: 6px solid #000; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
    .score-val { font-size: 36px; font-weight: bold; line-height: 1; }
    .score-lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #555; margin-top: 5px; }
    
    .trend-box { font-size: 13px; margin-top: 8px; font-weight: 500; }
    .t-up { color: #27ae60; } .t-down { color: #c0392b; } .t-neut { color: #7f8c8d; }

    .kpi-section { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi-box { border: 1px solid #000; background: #fff; padding: 10px; display: flex; flex-direction: column; justify-content: center; text-align: center; }
    .kpi-num { font-size: 20px; font-weight: bold; }
    .kpi-lbl { font-size: 10px; text-transform: uppercase; color: #555; margin-top: 5px; }

    /* --- TABULKA --- */
    table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 20px; }
    th { background-color: #eee; font-weight: bold; text-transform: uppercase; border: 1px solid #000; padding: 6px; text-align: left; }
    td { border: 1px solid #000; padding: 6px; vertical-align: top; color: #000; }
    .problem-text { font-weight: bold; text-decoration: underline; }

    /* √öPRAVA 3: Pravidla pro zalomen√≠ str√°nky v tabulce */
    thead { display: table-header-group; } /* Opakuje hlaviƒçku na nov√© str√°nce */
    tr { page-break-inside: avoid; break-inside: avoid; } /* Zabr√°n√≠ rozseknut√≠ ≈ô√°dku nap≈Øl */

    /* --- PATIƒåKA --- */
    /* √öPRAVA 4: Patiƒçka u≈æ nen√≠ absolutn√≠, ale fluidn√≠ */
    .footer { 
      margin-top: auto; /* Vytlaƒç√≠ patiƒçku dol≈Ø, pokud je obsah kr√°tk√Ω */
      padding-top: 20px; /* Mezera od obsahu */
      border-top: 1px solid #000; 
      font-size: 10px; 
      color: #333; 
      display: flex; 
      justify-content: space-between; 
    }
    
    .btn-print { display: block; width: 200px; margin: 0 auto 20px auto; padding: 10px; background: #333; color: white; text-align: center; cursor: pointer; border-radius: 5px; font-weight: bold; }
    .btn-print:hover { background: #000; }
  </style>
</head>
<body>

  <div class="no-print btn-print" onclick="window.print()">üñ®Ô∏è Vytisknout Report</div>

  <div class="page" id="report">
    <div style="text-align: center; padding-top: 150px; color: #888;">Naƒç√≠t√°m data...</div>
  </div>

<script>
  grist.ready({
    columns: ['Tiskova_Data'],
    requiredAccess: 'read table'
  });

  grist.onRecord(function(record) {
    const container = document.getElementById('report');
    const rawData = record.Tiskova_Data;

    if (!rawData) {
      container.innerHTML = '<div style="text-align:center; padding-top:50px;">≈Ω√°dn√° data (pr√°zdn√Ω vstup).</div>';
      return;
    }

    let data;
    try {
      data = JSON.parse(rawData);
    } catch (e) {
      container.innerHTML = '<div style="color:red; text-align:center; padding:50px;">CHYBA DAT:<br>' + rawData + '</div>';
      return;
    }
    
    if (data.error) {
       container.innerHTML = '<div style="color:red; text-align:center; padding:50px;">CHYBA PYTHONU:<br>' + data.error + '</div>';
       return;
    }

    const h = data.hlavicka;

    let trendHtml = '';
    if (h.trend_label) {
        let val = h.trend_val;
        let arrow = '‚û°';
        let cls = 't-neut';
        let sign = '';
        if (val > 0.1) { arrow = '‚Üó'; cls = 't-up'; sign = '+'; }
        else if (val < -0.1) { arrow = '‚Üò'; cls = 't-down'; sign = ''; }
        
        trendHtml = `<div class="trend-box ${cls}">${arrow} ${sign}${val.toFixed(1)} % <span style="color:#000; font-weight:normal; margin-left:3px;">${h.trend_label}</span></div>`;
    }

    let html = `
      <div class="header">
        <div>
          <img src="https://www.streicher.cz/fileadmin/Vorlage/images/logo.png" alt="Logo" class="logo-img">
          <h1>${h.dodavatel}</h1>
          <div style="font-size:12px; text-transform:uppercase; color:#444;">Kvart√°ln√≠ vyhodnocen√≠</div>
        </div>
        <div class="meta-date">
          Obdob√≠: ${h.obdobi}
        </div>
      </div>

      <div class="dashboard-container">
        <div class="score-section">
          <span class="score-val">${h.skore_procenta} %</span>
          <span class="score-lbl">Celkov√© hodnocen√≠</span>
          ${trendHtml}
        </div>

        <div class="kpi-section">
          <div class="kpi-box">
            <span class="kpi-num" style="white-space: nowrap;">${h.obrat}</span>
            <span class="kpi-lbl">Obrat</span>
          </div>
          <div class="kpi-box">
            <span class="kpi-num">${h.pocet_celkem}</span>
            <span class="kpi-lbl">Objedn√°vek</span>
          </div>
          <div class="kpi-box">
            <span class="kpi-num">${h.pocet_zpozdenych}</span>
            <span class="kpi-lbl">Opo≈ædƒõn√Ωch</span>
          </div>
        </div>
      </div>

      <h3 style="font-size:14px; text-transform:uppercase; border-bottom:1px solid #ccc; margin-bottom:5px;">Detailn√≠ p≈ôehled</h3>
      <table>
        <thead>
          <tr>
            <th style="width: 12%">Vystaveno</th>
            <th style="width: 15%">Objedn√°vka</th>
            <th style="width: 18%; text-align: right;">Cena</th>
            <th style="width: 15%; padding-left: 10px;">Status</th>
            <th style="width: 40%">Pozn√°mka / Probl√©m</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (data.radky && data.radky.length > 0) {
      data.radky.forEach(r => {
        let probContent = r.je_problem ? `<span class="problem-text">${r.text_problemu}</span>` : '';
        html += `
          <tr>
            <td>${r.datum}</td>
            <td>${r.cislo}</td>
            <td style="text-align: right;">${r.cena}</td>
            <td style="padding-left: 10px;">${r.status}</td>
            <td>${probContent}</td>
          </tr>
        `;
      });
    } else {
        html += `<tr><td colspan="5" style="text-align:center; padding: 20px;">≈Ω√°dn√© objedn√°vky.</td></tr>`;
    }

    html += `
        </tbody>
      </table>

      <div class="footer">
        <span>Intern√≠ report hodnocen√≠ dodavatel≈Ø</span>
        <span>Vyti≈°tƒõno: ${new Date().toLocaleDateString('cs-CZ')}</span>
      </div>
    `;

    container.innerHTML = html;
  });
</script>

</body>
</html>

