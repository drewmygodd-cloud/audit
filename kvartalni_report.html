<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Kvart√°ln√≠ Report</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* RESET A Z√ÅKLAD */
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: #f4f4f4; /* ≈†ed√© pozad√≠ na obrazovce */
      margin: 0;
      padding: 20px;
      color: #000;
    }

    /* TLAƒå√çTKO PRO TISK (Na pap√≠≈ôe zmiz√≠) */
    .print-btn-container {
      text-align: right;
      max-width: 210mm;
      margin: 0 auto 10px auto;
    }
    
    button.print-btn {
      background-color: #333;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 4px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button.print-btn:hover { background-color: #000; }

    /* KONTEJNER STR√ÅNKY (Vzhled A4 na obrazovce) */
    .page {
      background: white;
      max-width: 210mm;
      min-height: 297mm; /* Aby to vypadalo jako pap√≠r */
      margin: 0 auto;
      padding: 15mm;     /* Vnit≈ôn√≠ okraje obsahu */
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    /* HLAVIƒåKA */
    header {
      border-bottom: 2px solid #000;
      padding-bottom: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    h1 { margin: 0; font-size: 24px; text-transform: uppercase; color: #000; letter-spacing: 0.5px; }
    .sub { font-size: 14px; color: #444; margin-top: 5px; }

    .score-box { 
      border: 2px solid #000; 
      padding: 5px 15px; 
      text-align: center; 
      min-width: 90px;
    }
    .score-val { font-size: 26px; font-weight: bold; display: block; line-height: 1.2; }
    .score-lbl { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

    /* KPI LI≈†TA */
    .kpi-bar {
      display: flex;
      border: 1px solid #999;
      padding: 15px 0;
      margin-bottom: 25px;
      background-color: #fff;
    }
    .kpi-item {
      flex: 1;
      text-align: center;
      border-right: 1px solid #ccc;
    }
    .kpi-item:last-child { border-right: none; }
    .kpi-val { font-weight: bold; font-size: 16px; display: block; margin-bottom: 2px; }
    .kpi-lbl { font-size: 10px; text-transform: uppercase; color: #555; }

    /* TABULKA */
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    
    th { 
      text-align: left; 
      border-bottom: 2px solid #000; 
      padding: 8px 6px; 
      text-transform: uppercase;
      font-weight: bold;
    }
    
    td { 
      border-bottom: 1px solid #ccc; 
      padding: 6px; 
      vertical-align: top;
      color: #000;
    }

    /* Prou≈ækov√°n√≠ pro lep≈°√≠ ƒçitelnost */
    tr:nth-child(even) { background-color: #f2f2f2; }

    /* Styl probl√©m≈Ø - jen tuƒçnƒõ a podtr≈æenƒõ */
    .problem-text { font-weight: bold; text-decoration: underline; }

    /* PATIƒåKA */
    .footer {
      margin-top: 40px;
      border-top: 1px solid #000;
      padding-top: 5px;
      font-size: 10px;
      color: #333;
      display: flex;
      justify-content: space-between;
    }

    /* --- NASTAVEN√ç PRO TISK --- */
    @media print {
      /* Skryjeme tlaƒç√≠tko a okol√≠ */
      .print-btn-container, .print-btn { display: none !important; }
      
      body { 
        background-color: white; 
        padding: 0; 
        margin: 0;
        -webkit-print-color-adjust: exact; /* Vynut√≠ tisk pozad√≠ (≈°ed√© ≈ô√°dky) */
        print-color-adjust: exact;
      }

      /* Str√°nka se rozt√°hne na celou tiskovou oblast */
      .page {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 0; /* Nech√°me okraje na tisk√°rnƒõ nebo jen minim√°ln√≠ */
        box-shadow: none;
        border: none;
        min-height: auto;
      }

      /* Zajist√≠me, aby se tabulka nerozbila p≈ôes str√°nky o≈°klivƒõ */
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
    }
  </style>
</head>
<body>

<div class="print-btn-container">
  <button class="print-btn" onclick="window.print()">
    üñ®Ô∏è TISKNOUT WIDGET
  </button>
</div>

<div class="page" id="report">
  <div style="text-align: center; padding-top: 100px; color: #666;">Naƒç√≠t√°m data...</div>
</div>

<script>
  grist.ready({
    columns: ['Tiskova_Data'],
    requiredAccess: 'read table'
  });

  grist.onRecord(function(record) {
    const container = document.getElementById('report');
    const rawData = record.Tiskova_Data;

    if (!rawData) {
      container.innerHTML = '<div style="text-align:center; padding-top:50px;">≈Ω√°dn√° data pro zobrazen√≠.</div>';
      return;
    }

    let data;
    try {
      data = JSON.parse(rawData);
    } catch (e) {
      container.innerHTML = '<div style="color:red; text-align:center;">Chyba dat JSON</div>';
      return;
    }

    const h = data.hlavicka;

    let html = `
      <header>
        <div>
          <h1>${h.dodavatel}</h1>
          <div class="sub">Kvart√°ln√≠ hodnocen√≠: <strong>${h.obdobi}</strong></div>
        </div>
        <div class="score-box">
          <span class="score-val">${h.skore_procenta} %</span>
          <span class="score-lbl">V√Ωsledek</span>
        </div>
      </header>

      <div class="kpi-bar">
        <div class="kpi-item">
          <span class="kpi-val">${h.obrat}</span>
          <span class="kpi-lbl">Obrat</span>
        </div>
        <div class="kpi-item">
          <span class="kpi-val">${h.pocet_celkem}</span>
          <span class="kpi-lbl">Objedn√°vek</span>
        </div>
        <div class="kpi-item">
          <span class="kpi-val">${h.pocet_zpozdenych}</span>
          <span class="kpi-lbl">Probl√©mov√Ωch</span>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width: 12%">Datum</th>
            <th style="width: 15%">Objedn√°vka</th>
            <th style="width: 18%; text-align: right;">Cena</th>
            <th style="width: 15%; padding-left: 15px;">Status</th>
            <th style="width: 40%">Pozn√°mka</th>
          </tr>
        </thead>
        <tbody>
    `;

    if (data.radky && data.radky.length > 0) {
      data.radky.forEach(r => {
        // Pokud je probl√©m, pou≈æijeme span s t≈ô√≠dou, jinak pr√°zdno
        let probContent = r.je_problem ? `<span class="problem-text">${r.text_problemu}</span>` : '';
        
        html += `
          <tr>
            <td>${r.datum}</td>
            <td>${r.cislo}</td>
            <td style="text-align: right;">${r.cena}</td>
            <td style="padding-left: 15px;">${r.status}</td>
            <td>${probContent}</td>
          </tr>
        `;
      });
    } else {
        html += `<tr><td colspan="5" style="text-align:center; padding: 20px;">≈Ω√°dn√© z√°znamy v tomto obdob√≠.</td></tr>`;
    }

    html += `
        </tbody>
      </table>

      <div class="footer">
        <span>Intern√≠ report kvality</span>
        <span>Vyti≈°tƒõno: ${new Date().toLocaleDateString('cs-CZ')}</span>
      </div>
    `;

    container.innerHTML = html;
  });
</script>

</body>
</html>
